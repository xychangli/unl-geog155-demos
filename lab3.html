<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="image/Nebraska_N_RGB.png" type="image/png">
    <title>GEOG 155 Lab 3 GIS and VGI Demo</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        #map { height: 800px; margin: 20px; border: 2px solid white; }
        #logo-container { position: absolute; top: 20px; left: 30px; z-index: 1000; }
        #logo-container img { max-width: 120px; height: auto; display: block; }
        .popup-photo { display:block; max-width:280px; max-height:200px; margin-top:6px; border:1px solid #ddd; }
        .popup-loading { color:#666; font-size:0.9em; margin-top:6px; display:block; }
        .popup-link { display:block; margin-top:6px; font-size:0.9em; }
    </style>
    <meta name="author" content="Chang Li 李畅">
    <meta name="date" content="2025-02-18">
    <meta name="description" content="Interactive map to display Volunteered Geographic Information.">
</head>
<body>

<div id="logo-container">
    <img src="image/R_Nebraska_N_2023_name_RGB.png" alt="University of Nebraska-Lincoln">
</div>

<h2 style="text-align: center;">GEOG 155 Lab 3 GIS and VGI</h2>
<p style="text-align: center;">Chang Li @ UNL</p>
<p style="text-align: center;">
    <span style="display: inline-block; text-align: left;">
        Go to <a href="https://arcg.is/1WSeza" target="_blank" rel="noopener noreferrer">https://arcg.is/1WSeza</a> to participate.
        After submitting the survey, refresh this page.<br>
        Take a screenshot of your POI with the popup showing your name, section, rating, and review.<br>
        Submit the screenshot to Canvas.
    </span>
</p>

<div id="map"></div>

<script>
    const initialCenter = [40.82, -96.70];
    const bounds = L.latLngBounds([-90, -180], [90, 180]);

    const map = L.map('map', {
        worldCopyJump: false,
        maxBounds: bounds,
        maxBoundsViscosity: 0.9,
        minZoom: 2
    }).setView(initialCenter, 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap'
    }).addTo(map);

    // Feature layer base URL
    const featureLayerUrl = "https://services8.arcgis.com/jzdN07B7ZhRTxuzU/arcgis/rest/services/survey123_e28761d4a7bc44d98d45bf4925cc7238_results/FeatureServer/0";

    // If your layer requires a token, set it here (null for public)
    const ATTACHMENT_TOKEN = null; // or 'your_token_here'

    async function fetchSurveyData() {
        const outFields = "OBJECTID,student_name,student_section,poi_rating,poi_review";
        const queryUrl = `${featureLayerUrl}/query?where=1=1&outFields=${encodeURIComponent(outFields)}&returnGeometry=true&f=json`;

        try {
            const resp = await fetch(queryUrl);
            const data = await resp.json();
            if (data.error) { console.error("Feature query error:", data.error); return; }
            data.features.forEach(feature => {
                const lat = feature.geometry?.y;
                const lng = feature.geometry?.x;
                const attr = feature.attributes || {};
                if (typeof lat !== 'number' || typeof lng !== 'number') return;

                const marker = L.marker([lat, lng]).addTo(map);

                // Ensure we request OBJECTID from attributes
                const objectId = attr.OBJECTID || attr.objectid || attr.ObjectID || attr.FID;
                const basePopup = `
                    <div>
                      <b>Student Name:</b> ${attr.student_name || 'N/A'}<br>
                      <b>Lab Section:</b> ${attr.student_section || 'N/A'}<br>
                      <b>Rating:</b> ${attr.poi_rating || 'N/A'}<br>
                      <b>Review:</b> ${attr.poi_review || 'N/A'}<br>
                      <span class="popup-loading">Loading image...</span>
                    </div>
                `;
                marker.bindPopup(basePopup);

                // Fetch attachments for this objectId and show first image attachment if present
                (async () => {
                    if (!objectId) {
                        const noId = basePopup.replace('<span class="popup-loading">Loading image...</span>',
                            '<span class="popup-loading">No OBJECTID found; cannot load image.</span>');
                        marker.getPopup().setContent(noId);
                        return;
                    }
                    try {
                        // attachments endpoint for this feature
                        const attachUrl = `${featureLayerUrl}/${objectId}/attachments?f=json${ATTACHMENT_TOKEN ? '&token=' + encodeURIComponent(ATTACHMENT_TOKEN) : ''}`;
                        const aResp = await fetch(attachUrl);
                        const aJson = await aResp.json();
                        console.log("attachments for", objectId, aJson); // inspect in console

                        const infos = aJson?.attachmentInfos || aJson?.attachments || [];
                        if (!infos || infos.length === 0) {
                            const noImage = basePopup.replace('<span class="popup-loading">Loading image...</span>',
                                '<span class="popup-loading">No image uploaded</span>');
                            marker.getPopup().setContent(noImage);
                            return;
                        }

                        // pick the first image-like attachment, otherwise first attachment
                        const firstImg = infos.find(i => i.contentType && i.contentType.startsWith('image')) || infos[0];
                        const attachmentId = firstImg?.id ?? firstImg?.attachmentId ?? firstImg?.ATTACHMENTID;

                        if (typeof attachmentId === 'undefined') {
                            const missing = basePopup.replace('<span class="popup-loading">Loading image...</span>',
                                '<span class="popup-loading">Attachment ID not found in response</span>');
                            marker.getPopup().setContent(missing);
                            return;
                        }

                        // build the image URL and preload it
                        let imageUrl = `${featureLayerUrl}/${objectId}/attachments/${attachmentId}`;
                        if (ATTACHMENT_TOKEN) imageUrl += '?token=' + encodeURIComponent(ATTACHMENT_TOKEN);

                        await new Promise(resolve => {
                            const img = new Image();
                            img.onload = () => {
                                const html = `<a class="popup-link" href="${imageUrl}" target="_blank" rel="noopener noreferrer"><img class="popup-photo" src="${imageUrl}" alt="Survey photo"/></a>`;
                                const newContent = basePopup.replace('<span class="popup-loading">Loading image...</span>', html);
                                marker.getPopup().setContent(newContent);
                                resolve();
                            };
                            img.onerror = () => {
                                console.warn("Image load error for", imageUrl);
                                const fallback = `<span class="popup-loading">Image failed to load</span><a class="popup-link" href="${imageUrl}" target="_blank" rel="noopener noreferrer">Open image in new tab</a>`;
                                const newContent = basePopup.replace('<span class="popup-loading">Loading image...</span>', fallback);
                                marker.getPopup().setContent(newContent);
                                resolve();
                            };
                            img.src = imageUrl;
                        });

                    } catch (err) {
                        console.error("Error fetching attachments for", objectId, err);
                        const errHtml = basePopup.replace('<span class="popup-loading">Loading image...</span>',
                            '<span class="popup-loading">Error fetching attachments (see console)</span>');
                        marker.getPopup().setContent(errHtml);
                    }
                })();

            });

        } catch (err) {
            console.error("Failed to fetch features:", err);
        }
    }

    fetchSurveyData();
</script>

</body>
</html>
