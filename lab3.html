<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="image/Nebraska_N_RGB.png" type="image/png">
    <title>GEOG 155 Lab 3 GIS and VGI Demo</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        #map { height: 800px; margin: 20px; border: 2px solid white; }
        #logo-container { position: absolute; top: 20px; left: 30px; z-index: 1000; }
        #logo-container img { max-width: 120px; height: auto; display: block; }
        .popup-photo { display:block; max-width:280px; max-height:200px; margin-top:6px; border:1px solid #ddd; }
        .popup-loading { color:#666; font-size:0.9em; margin-top:6px; display:block; }
        .popup-link { margin-top:6px; display:block; font-size:0.9em; }
    </style>
    <meta name="author" content="Chang Li 李畅">
    <meta name="date" content="2025-02-18">
</head>
<body>
<div id="logo-container">
    <img src="image/R_Nebraska_N_2023_name_RGB.png" alt="University of Nebraska-Lincoln">
</div>

<h2 style="text-align: center;">GEOG 155 Lab 3 GIS and VGI</h2>
<p style="text-align: center;">Chang Li @ UNL</p>
<p style="text-align: center;">
    <span style="display: inline-block; text-align: left;">
        Go to <a href="https://arcg.is/1WSeza" target="_blank" rel="noopener noreferrer">https://arcg.is/1WSeza</a> to participate.
        After submitting the survey, refresh this page.<br>
        Take a screenshot of your POI with the popup showing your name, section, rating, and review.<br>
        Submit the screenshot to Canvas.
    </span>
</p>

<div id="map"></div>

<script>
(async () => {
  const featureLayerUrl = "https://services8.arcgis.com/jzdN07B7ZhRTxuzU/arcgis/rest/services/survey123_e28761d4a7bc44d98d45bf4925cc7238_results/FeatureServer/0";
  // If your layer requires a token, set it here:
  const ATTACHMENT_TOKEN = null; // e.g. "XXXXX" or null for public layers

  const initialCenter = [40.82, -96.70];
  const bounds = L.latLngBounds([-90, -180], [90, 180]);
  const map = L.map('map', { worldCopyJump:false, maxBounds:bounds, maxBoundsViscosity:0.9, minZoom:2 }).setView(initialCenter, 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);

  // 1) fetch features (attributes + geometry)
  const outFields = "OBJECTID,student_name,student_section,poi_rating,poi_review";
  const queryUrl = `${featureLayerUrl}/query?where=1=1&outFields=${encodeURIComponent(outFields)}&returnGeometry=true&f=json`;
  let features;
  try {
    const resp = await fetch(queryUrl);
    const json = await resp.json();
    if (json.error) { console.error("Feature query error:", json.error); return; }
    features = json.features || [];
    console.log("Fetched features count:", features.length);
  } catch (err) {
    console.error("Failed to fetch features:", err);
    return;
  }

  if (features.length === 0) return;

  // 2) build list of objectIds and request attachments for all of them in one call
  const objectIds = features.map(f => f.attributes?.OBJECTID).filter(id => typeof id === 'number');
  if (objectIds.length === 0) {
    console.warn("No OBJECTIDs found in features.");
  }

  // Construct queryAttachments URL (use objectIds parameter)
  const attachmentQueryUrl = `${featureLayerUrl}/queryAttachments?objectIds=${objectIds.join(',')}&f=json${ATTACHMENT_TOKEN ? '&token=' + encodeURIComponent(ATTACHMENT_TOKEN) : ''}`;
  let attachmentsJson = {};
  try {
    const aResp = await fetch(attachmentQueryUrl);
    attachmentsJson = await aResp.json();
    console.log("queryAttachments result:", attachmentsJson);
  } catch (err) {
    console.warn("Failed to fetch queryAttachments (will try per-feature attachments):", err);
    attachmentsJson = {}; // we'll still try per-feature later
  }

  // Build a map: objectId -> array of attachmentInfos
  const attachmentsMap = {};
  if (attachmentsJson?.attachmentGroups && Array.isArray(attachmentsJson.attachmentGroups)) {
    attachmentsJson.attachmentGroups.forEach(group => {
      const oid = group?.parentObjectId;
      const infos = group?.attachmentInfos || [];
      attachmentsMap[oid] = infos;
    });
  } else if (attachmentsJson?.attachmentInfos && Array.isArray(attachmentsJson.attachmentInfos)) {
    // fallback (unlikely)
    attachmentsJson.attachmentInfos.forEach(info => {
      const oid = info?.parentObjectId || info?.objectId;
      attachmentsMap[oid] = attachmentsMap[oid] || [];
      attachmentsMap[oid].push(info);
    });
  }

  // Helper: build attachment URL given objectId and attachmentId
  function buildAttachmentUrl(objectId, attachmentId) {
    let url = `${featureLayerUrl}/${objectId}/attachments/${attachmentId}`;
    if (ATTACHMENT_TOKEN) url += '?token=' + encodeURIComponent(ATTACHMENT_TOKEN);
    return url;
  }

  // For each feature, add marker + popup. If attachmentsMap doesn't contain entries for that objectId,
  // we'll attempt a per-feature attachments fetch.
  for (const feature of features) {
    const geom = feature.geometry;
    if (!geom || typeof geom.x !== 'number' || typeof geom.y !== 'number') continue;
    const lat = geom.y, lng = geom.x;
    const attr = feature.attributes || {};
    const objectId = attr.OBJECTID;

    const marker = L.marker([lat, lng]).addTo(map);

    // base popup content with placeholder
    const baseContent = `
      <div>
        <b>Student Name:</b> ${attr.student_name || 'N/A'}<br>
        <b>Lab Section:</b> ${attr.student_section || 'N/A'}<br>
        <b>Rating:</b> ${attr.poi_rating || 'N/A'}<br>
        <b>Review:</b> ${attr.poi_review || 'N/A'}<br>
        <span class="popup-loading">Loading image...</span>
      </div>
    `;
    marker.bindPopup(baseContent);

    // find attachments for this objectId (from bulk query response if available)
    let infos = attachmentsMap[objectId];

    // If not found, try per-feature attachments endpoint (fallback)
    if ((!infos || infos.length === 0) && objectId) {
      try {
        const perUrl = `${featureLayerUrl}/${objectId}/attachments?f=json${ATTACHMENT_TOKEN ? '&token=' + encodeURIComponent(ATTACHMENT_TOKEN) : ''}`;
        const pResp = await fetch(perUrl);
        const pJson = await pResp.json();
        // ArcGIS typically returns 'attachmentInfos'
        infos = pJson?.attachmentInfos || pJson?.attachments || [];
        if (infos && infos.length > 0) {
          attachmentsMap[objectId] = infos; // cache it
        }
        console.log(`attachments for ${objectId}:`, infos);
      } catch (err) {
        console.warn("per-feature attachments fetch failed for", objectId, err);
      }
    }

    // choose first image-like attachment if present
    let imageHtml = '<span class="popup-loading">No image uploaded</span>';
    if (infos && infos.length > 0) {
      const firstImg = infos.find(a => a.contentType && a.contentType.startsWith('image')) || infos[0];
      const aid = firstImg?.id ?? firstImg?.attachmentId ?? firstImg?.ATTACHMENTID;
      if (typeof aid !== 'undefined') {
        const imageUrl = buildAttachmentUrl(objectId, aid);
        // preload
        await new Promise(resolve => {
          const img = new Image();
          img.onload = () => {
            imageHtml = `<a class="popup-link" href="${imageUrl}" target="_blank" rel="noopener noreferrer"><img class="popup-photo" src="${imageUrl}" alt="Survey photo" /></a>`;
            resolve();
          };
          img.onerror = () => {
            console.warn("Image failed to load:", imageUrl);
            imageHtml = `<span class="popup-loading">Image failed to load (see console)</span>
                         <a class="popup-link" href="${imageUrl}" target="_blank" rel="noopener noreferrer">Open image in new tab</a>`;
            resolve();
          };
          img.src = imageUrl;
        });
      } else {
        imageHtml = '<span class="popup-loading">Attachment id missing</span>';
      }
    }

    // set the new content into the popup (works whether it's open or not)
    const newContent = baseContent.replace('<span class="popup-loading">Loading image...</span>', imageHtml);
    marker.getPopup().setContent(newContent);
  } // end features loop

  console.log("All markers added.");
})(); 
</script>
</body>
</html>
